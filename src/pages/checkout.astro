---
import BaseLayout from '../layouts/BaseLayout.astro';
import Header from '../components/Header.astro';
import Footer from '../components/Footer.astro';

// Site ID and API base URL (these would be set during deployment)
const siteId = import.meta.env.PUBLIC_SITE_ID || 'demo-site-id';
const apiBaseUrl = import.meta.env.PUBLIC_API_BASE_URL || 'https://contentflow.vercel.app';
---

<BaseLayout
  title="Checkout - Wellstone Breads"
  description="Complete your order for fresh artisan breads"
>
  <Header />

  <main class="py-16 bg-gray-50 min-h-screen">
    <div class="container mx-auto px-4 max-w-4xl">
      <h1 class="text-4xl font-bold text-center text-gray-900 mb-12">Checkout</h1>

      <div class="grid grid-cols-1 md:grid-cols-2 gap-8">
        <!-- Order Form -->
        <div class="bg-white rounded-lg shadow-lg p-8">
          <h2 class="text-2xl font-bold text-gray-900 mb-6">Your Information</h2>

          <form id="checkout-form" class="space-y-4">
            <!-- Customer Name -->
            <div>
              <label for="name" class="block text-sm font-medium text-gray-700 mb-1">
                Full Name *
              </label>
              <input
                type="text"
                id="name"
                name="name"
                required
                class="w-full px-4 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-primary focus:border-transparent"
              />
            </div>

            <!-- Email -->
            <div>
              <label for="email" class="block text-sm font-medium text-gray-700 mb-1">
                Email *
              </label>
              <input
                type="email"
                id="email"
                name="email"
                required
                class="w-full px-4 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-primary focus:border-transparent"
              />
            </div>

            <!-- Phone -->
            <div>
              <label for="phone" class="block text-sm font-medium text-gray-700 mb-1">
                Phone Number
              </label>
              <input
                type="tel"
                id="phone"
                name="phone"
                class="w-full px-4 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-primary focus:border-transparent"
              />
            </div>

            <!-- Pickup Time -->
            <div>
              <label for="pickupTime" class="block text-sm font-medium text-gray-700 mb-1">
                Preferred Pickup Time
              </label>
              <input
                type="datetime-local"
                id="pickupTime"
                name="pickupTime"
                class="w-full px-4 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-primary focus:border-transparent"
              />
            </div>

            <!-- Delivery Notes -->
            <div>
              <label for="notes" class="block text-sm font-medium text-gray-700 mb-1">
                Special Instructions
              </label>
              <textarea
                id="notes"
                name="notes"
                rows="3"
                class="w-full px-4 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-primary focus:border-transparent"
              ></textarea>
            </div>

            <!-- Submit Button -->
            <button
              type="submit"
              id="submit-btn"
              class="w-full bg-primary hover:bg-accent text-white font-semibold py-3 px-6 rounded-lg transition-colors duration-200"
            >
              Proceed to Payment
            </button>
          </form>

          <p class="text-xs text-gray-500 mt-4 text-center">
            You will be redirected to Stripe to complete your payment securely.
          </p>
        </div>

        <!-- Order Summary -->
        <div class="bg-white rounded-lg shadow-lg p-8">
          <h2 class="text-2xl font-bold text-gray-900 mb-6">Order Summary</h2>

          <div id="order-items" class="space-y-4 mb-6">
            <!-- Cart items will be inserted here -->
          </div>

          <div class="border-t border-gray-200 pt-4">
            <div class="flex justify-between text-lg font-bold">
              <span>Total</span>
              <span id="order-total">$0.00</span>
            </div>
          </div>
        </div>
      </div>
    </div>
  </main>

  <Footer />

  <script define:vars={{ siteId, apiBaseUrl }}>
    // Load cart and display order summary
    let cart = [];
    try {
      const savedCart = localStorage.getItem('cart');
      if (savedCart) {
        cart = JSON.parse(savedCart);
      }
    } catch (e) {
      console.error('Failed to load cart:', e);
    }

    // Display cart items
    const orderItemsContainer = document.getElementById('order-items');
    const orderTotalEl = document.getElementById('order-total');

    if (cart.length === 0) {
      orderItemsContainer.innerHTML = '<p class="text-gray-600">Your cart is empty</p>';
      document.getElementById('submit-btn').disabled = true;
      document.getElementById('submit-btn').classList.add('opacity-50', 'cursor-not-allowed');
    } else {
      const subtotal = cart.reduce((sum, item) => sum + item.price * item.quantity, 0);

      orderItemsContainer.innerHTML = cart
        .map(
          (item) => `
        <div class="flex justify-between items-center py-2 border-b border-gray-200">
          <div>
            <p class="font-medium text-gray-900">${item.name}</p>
            <p class="text-sm text-gray-600">Qty: ${item.quantity} Ã— $${item.price.toFixed(2)}</p>
          </div>
          <p class="font-medium text-gray-900">$${(item.price * item.quantity).toFixed(2)}</p>
        </div>
      `
        )
        .join('');

      orderTotalEl.textContent = `$${subtotal.toFixed(2)}`;
    }

    // Handle form submission
    document.getElementById('checkout-form').addEventListener('submit', async (e) => {
      e.preventDefault();

      const submitBtn = document.getElementById('submit-btn');
      submitBtn.disabled = true;
      submitBtn.textContent = 'Processing...';

      const formData = new FormData(e.target);

      try {
        const response = await fetch(`${apiBaseUrl}/api/sites/${siteId}/checkout`, {
          method: 'POST',
          headers: { 'Content-Type': 'application/json' },
          body: JSON.stringify({
            items: cart.map((item) => ({
              productId: item.productId,
              quantity: item.quantity,
            })),
            customerName: formData.get('name'),
            customerEmail: formData.get('email'),
            customerPhone: formData.get('phone'),
            deliveryNotes: formData.get('notes'),
            pickupTime: formData.get('pickupTime'),
            successUrl: `${window.location.origin}/order-confirmation`,
            cancelUrl: `${window.location.origin}/checkout`,
          }),
        });

        if (response.ok) {
          const data = await response.json();
          // Redirect to Stripe Checkout
          window.location.href = data.sessionUrl;
        } else {
          const data = await response.json();
          alert(`Checkout failed: ${data.error}`);
          submitBtn.disabled = false;
          submitBtn.textContent = 'Proceed to Payment';
        }
      } catch (error) {
        alert('An error occurred. Please try again.');
        submitBtn.disabled = false;
        submitBtn.textContent = 'Proceed to Payment';
      }
    });
  </script>
</BaseLayout>
